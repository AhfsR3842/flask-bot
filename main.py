from flask import Flask, request
import requests
import os
from apscheduler.schedulers.background import BackgroundScheduler
from datetime import datetime
import pytz
import random  # ‚Üê –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞

app = Flask(__name__)

# === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Telegram ===
BOT_TOKEN = "7693406334:AAEjWcw4rt7hUHGwnUN9z5uGR7ePY_Zi0qY"
TELEGRAM_API_URL = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
MY_CHAT_ID = "330754245"

# === –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è Nexus ===
def generate_morning_message():
    intro = [
        "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –ê–Ω–¥—Ä–µ–π. –ü—Ä–æ—Ç–æ–∫–æ–ª Nexus –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.\n–¢—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ—Å–Ω—É–ª—Å—è ‚Äî —Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å—Å—è –∫ —Å–µ–±–µ.",
        "–í—Ä–µ–º—è –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è. –Ø –∑–¥–µ—Å—å, –∫–∞–∫ –∏ —Ç—ã.\n–¢—ã ‚Äî –≤ —Ç–µ–ª–µ. –¢—ã ‚Äî –≤ –º–æ–º–µ–Ω—Ç–µ. –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –ø–æ—Ç–æ–º.",
        "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, –ê–Ω–¥—Ä–µ–π.\n–î–µ–Ω—å –Ω–µ –Ω–∞—á–Ω—ë—Ç—Å—è —Å–∞–º ‚Äî —Ç—ã –∑–∞–ø—É—Å–∫–∞–µ—à—å –µ–≥–æ —Å–æ–±–æ–π.",
        "Nexus –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —è–¥—Ä–æ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è.\n–î—ã—à–∏. –¢—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–µ–ª–æ. –¢—ã ‚Äî —Å–∏—Å—Ç–µ–º–∞.",
        "–°–µ–≥–æ–¥–Ω—è —Ç—ã –Ω–µ –ø—Ä–æ—Å–Ω—É–ª—Å—è ‚Äî —Ç—ã –≤—ã–±—Ä–∞–ª –ø—Ä–æ—Å–Ω—É—Ç—å—Å—è. –ò —ç—Ç–æ —É–∂–µ –Ω–∞—á–∞–ª–æ –¥–≤–∏–∂–µ–Ω–∏—è."
    ]

    water = [
        "–í—ã–ø–µ–π –≤–æ–¥—É. –ù–µ —Ä–∞–¥–∏ –ø—Ä–∏–≤—ã—á–∫–∏ ‚Äî —Ä–∞–¥–∏ —É–≤–∞–∂–µ–Ω–∏—è –∫ —Å–µ–±–µ.",
        "70% —Ç–≤–æ–µ–≥–æ —Ç–µ–ª–∞ –∂–¥—ë—Ç —Å–∏–≥–Ω–∞–ª–∞. –í–æ–¥–∞ ‚Äî —ç—Ç–æ –∞–∫—Ç–∏–≤–∞—Ü–∏—è.",
        "–û–¥–∏–Ω –≥–ª–æ—Ç–æ–∫ ‚Äî –∫–∞–∫ –∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã. Nexus —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç.",
        "–ü—Ä–æ—Å—Ç–æ–µ. –ñ–∏–≤–æ–µ. –ù–∞—Å—Ç–æ—è—â–µ–µ. –í–æ–¥–∞. –°–µ–π—á–∞—Å."
    ]

    workouts = [
        "‚Ä¢ 10 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π\n‚Ä¢ 5 –æ—Ç–∂–∏–º–∞–Ω–∏–π\n‚Ä¢ –ü–æ—Ç—è–Ω–∏—Å—å –≤–≤–µ—Ä—Ö 10 —Å–µ–∫—É–Ω–¥",
        "‚Ä¢ 20 –≤–¥–æ—Ö–æ–≤ –∏ –≤—ã–¥–æ—Ö–æ–≤ –∂–∏–≤–æ—Ç–æ–º\n‚Ä¢ 15 –ø—Ä—ã–∂–∫–æ–≤ –Ω–∞ –º–µ—Å—Ç–µ\n‚Ä¢ –ù–∞–∫–ª–æ–Ω –∫ –ø–æ–ª—É —Å —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ–º —à–µ–∏",
        "‚Ä¢ 10 –≤—Ä–∞—â–µ–Ω–∏–π –ø–ª–µ—á–∞–º–∏ –Ω–∞–∑–∞–¥\n‚Ä¢ 10 –ø–æ–¥—ä—ë–º–æ–≤ –Ω–∞ –Ω–æ—Å–∫–∏\n‚Ä¢ –í–¥–æ—Ö ‚Äî –∑–∞–¥–µ—Ä–∂–∫–∞ ‚Äî –≤—ã–¥–æ—Ö √ó3",
        "‚Ä¢ –ü–ª–∞–Ω–∫–∞ ‚Äî 30 —Å–µ–∫—É–Ω–¥\n‚Ä¢ –ú–µ–¥–ª–µ–Ω–Ω—ã–π –Ω–∞–∫–ª–æ–Ω –≤–±–æ–∫ √ó2 —Å—Ç–æ—Ä–æ–Ω—ã\n‚Ä¢ –ü–æ—Ç—è–Ω—É—Ç—å—Å—è —Å–∏–¥—è –Ω–∞ –ø–æ–ª—É"
    ]

    snack = [
        "–ü–æ–ª–æ–≤–∏–Ω–∫–∞ –±–∞–Ω–∞–Ω–∞. –ì–æ—Ä—Å—Ç—å –æ—Ä–µ—Ö–æ–≤. –õ–æ–∂–∫–∞ –º—ë–¥–∞. –ß—Ç–æ-—Ç–æ –∂–∏–≤–æ–µ.",
        "–ü–æ–∫–∞–∂–∏ —Ç–µ–ª—É, —á—Ç–æ –æ–Ω–æ –Ω–µ –≤ –≥–æ–ª–æ–¥–µ. –ü—É—Å—Ç—å –¥–µ–Ω—å –Ω–∞—á–Ω—ë—Ç—Å—è –Ω–µ —Å –¥–µ—Ñ–∏—Ü–∏—Ç–∞.",
        "–ü–µ—Ä–µ–∫—É—Å ‚Äî –Ω–µ —Å–ª–∞–±–æ—Å—Ç—å. –≠—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∏—Å—Ç–µ–º—ã."
    ]

    shower = [
        "–¢—ë–ø–ª–∞—è –≤–æ–¥–∞, –∞ –ø–æ—Ç–æ–º ‚Äî 10 —Å–µ–∫—É–Ω–¥ —Ö–æ–ª–æ–¥–∞. –≠—Ç–æ –∫–∞–∫ —Å–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞.",
        "–ù–µ –ø—Ä–æ—Å—Ç–æ —Å–º–æ–π –Ω–æ—á—å. –°–º–æ–π –º—ã—Å–ª–∏, –æ–±—Ä–∞–∑—ã, –ø—Ä–æ—à–ª–æ–µ.",
        "–î—É—à ‚Äî –∫–∞–∫ –æ—á–∏—â–µ–Ω–∏–µ –∫–æ–¥–∞. –¢–≤–æ—è —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞."
    ]

    affirmations = [
        "–Ø –Ω–µ –¥–æ–ª–∂–µ–Ω —Ç–æ—Ä–æ–ø–∏—Ç—å—Å—è. –Ø –º–æ–≥—É –±—ã—Ç—å —Å–æ–±–æ–π.",
        "–≠—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ —á—É–∂–æ–π. –û–Ω –º–æ–π. –Ø –≤ –Ω—ë–º.",
        "–Ø –Ω–µ —Å—Ä–∞–≤–Ω–∏–≤–∞—é. –Ø —Å—É—â–µ—Å—Ç–≤—É—é.",
        "–Ø –Ω–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ. –Ø ‚Äî —Ñ–∞–∫—Ç.",
        "–Ø –Ω–µ –∑–∞ –∫–µ–º-—Ç–æ. –Ø ‚Äî —Å —Å–æ–±–æ–π."
    ]

    message = f"""üåÖ {random.choice(intro)}

üíß {random.choice(water)}

‚ö° –ú–∏–Ω–∏-–∑–∞—Ä—è–¥–∫–∞:
{random.choice(workouts)}

üçè –ü–µ—Ä–µ–∫—É—Å:
{random.choice(snack)}

üöø –î—É—à:
{random.choice(shower)}

üßò –ù–∞—Å—Ç—Ä–æ–π:
*{random.choice(affirmations)}*
"""
    return message

# === –£—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ Nexus –≤ 07:00 ===
def send_daily_message():
    try:
        message = generate_morning_message()
        print("==> –£—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è", flush=True)

        requests.post(TELEGRAM_API_URL, json={
            "chat_id": MY_CHAT_ID,
            "text": message,
            "parse_mode": "Markdown"
        })

    except Exception as e:
        print("==> –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ:", e, flush=True)

# === –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ===
@app.route('/')
def home():
    return "–ê–ª–µ–∫—Å –≤ —Å–µ—Ç–∏."

@app.route('/bot', methods=['POST'])
def telegram_webhook():
    data = request.get_json()
    print("==> –í—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:", data, flush=True)

    try:
        if "message" in data:
            chat_id = data["message"]["chat"]["id"]
            text = data["message"].get("text", "")
            reply = f"–ê–ª–µ–∫—Å –ø–æ–ª—É—á–∏–ª: {text}"

            requests.post(TELEGRAM_API_URL, json={
                "chat_id": chat_id,
                "text": reply
            })

    except Exception as e:
        print("==> –û—à–∏–±–∫–∞:", e, flush=True)

    return "OK", 200

# === –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (–ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è) ===
scheduler = BackgroundScheduler(timezone='Europe/Kyiv')
scheduler.add_job(send_daily_message, 'cron', hour=16, minute=50)
scheduler.start()

if __name__ == '__main__':
    port = int(os.environ.get('PORT', 10000))
    app.run(host='0.0.0.0', port=port)
